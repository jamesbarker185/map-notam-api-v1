<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NOTAM Visualization</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <!-- Turf.js for Geospatial Calcs -->
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Glassmorphism Panel */
        .panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            background: rgba(30, 30, 30, 0.9);
            color: white;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        h2 { margin-top: 0; font-size: 1.2rem; color: #fff; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; color: #ccc; }
        
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #555;
            background: #222;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        
        .legend {
            margin-top: 20px;
            border-top: 1px solid #444;
            padding-top: 15px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; color: #ddd; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        
        /* Popups */
        .mapboxgl-popup { max-width: 400px; }
        .mapboxgl-popup-content { border-radius: 8px; padding: 15px; background: #222; color: #fff; }
        .mapboxgl-popup-tip { border-top-color: #222; }
        .notam-popup h3 { margin: 0 0 10px 0; font-size: 1rem; color: #007AFF; }
        .notam-popup p { margin: 5px 0; font-size: 0.9rem; line-height: 1.4; color: #ccc; }
        .tag { 
            display: inline-block; padding: 2px 6px; 
            border-radius: 4px; background: #444; 
            font-size: 0.75rem; font-weight: 600; 
        }

        /* Side Panel */
        .side-panel {
            left: auto;
            right: 20px;
            width: 380px;
            bottom: 20px;
            top: 20px;
            overflow-y: auto;
            display: none; /* Hidden by default */
            border-left: 1px solid #444;
        }
        
        .side-panel.open { display: block; }

        .notam-list-item {
            background: #2a2a2a;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #888;
            cursor: pointer;
            transition: background 0.2s;
        }
        .notam-list-item:hover { background: #333; }
        
        .notam-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .notam-id { font-weight: bold; color: #fff; font-size: 0.95rem; }
        .notam-date { font-size: 0.75rem; color: #aaa; }
        
        .notam-details { 
            display: none; 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px solid #444; 
        }
        .notam-list-item.expanded .notam-details { display: block; }
        
        .detail-row { font-size: 0.85rem; color: #ccc; margin-bottom: 4px; }
        .detail-label { color: #888; font-weight: 500; min-width: 60px; display: inline-block; }
        
        .raw-text {
            background: #111;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #0f0;
            white-space: pre-wrap;
            margin-top: 8px;
        }

        .toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            width: auto;
        }
        .toggle-btn:hover { background: #444; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <h2>NOTAM Explorer</h2>
    
    <div class="control-group">
        <label>Search Radius (NM)</label>
        <input type="range" id="radiusInput" min="5" max="100" value="20" oninput="radiusVal.textContent = this.value">
        <span id="radiusVal">20</span> NM
    </div>
    
    <div class="control-group">
        <label>Coordinates (Lat, Lon)</label>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="latInput" placeholder="Lat" value="42.3656">
            <input type="text" id="lonInput" placeholder="Lon" value="-71.0096">
        </div>
    </div>
    
    <button onclick="searchNotams()">Search Area</button>
    
    <div class="legend">
        <div class="legend-item"><div class="dot" style="background: #FA5252;"></div> Runway (Closed/WIP)</div>
        <div class="legend-item"><div class="dot" style="background: #FD7E14;"></div> Taxiway</div>
        <div class="legend-item"><div class="dot" style="background: #FCC419;"></div> Obstruction</div>
        <div class="legend-item"><div class="dot" style="background: #82C91E;"></div> Aerodrome</div>
        <div class="legend-item"><div class="dot" style="background: #228BE6;"></div> Airspace</div>
        <div class="legend-item"><div class="dot" style="background: #868E96;"></div> Other</div>
    </div>
    
    <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
        Click anywhere to update location.
    </div>
</div>

<button class="toggle-btn" onclick="toggleSidePanel()">Toggle List View</button>

<div class="panel side-panel" id="sidePanel">
    <h2>NOTAM List <span id="notamCount" style="font-size:0.8rem; color:#888; font-weight:normal; margin-left:10px;">(0)</span></h2>
    <div id="notamListContainer">
        <div style="text-align:center; padding:20px; color:#666;">Perform a search to see NOTAMs here.</div>
    </div>
</div>

<script>
    // TO MAKE IT WORK: 
    mapboxgl.accessToken = 'pk.eyJ1IjoiaW50dWl0aXZlYmFkZ2VyIiwiYSI6ImNtN2FkY2p5ZTAzMm8yanNjY3phdjZudjMifQ.vU_yL1OSajo2l4hKpGzTbA';

    // Initialize Map with Dark Theme
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11', // Professional dark mode
        center: [-71.0096, 42.3656], // Default: KBOS
        zoom: 10
    });

    // Navigation Controls
    map.addControl(new mapboxgl.NavigationControl());

    let currentMarker = null;

    // Load initial data when map matches default
    map.on('load', () => {
        setupLayers();
        searchNotams(); // Initial search
    });

    // Click to search
    map.on('click', (e) => {
        document.getElementById('latInput').value = e.lngLat.lat.toFixed(4);
        document.getElementById('lonInput').value = e.lngLat.lng.toFixed(4);
        
        // Update marker
        if (currentMarker) currentMarker.remove();
        currentMarker = new mapboxgl.Marker({ color: "#FF0000" })
            .setLngLat(e.lngLat)
            .addTo(map);
            
        searchNotams();
    });

    function setupLayers() {
        // Add Search Area Source (Circle)
        map.addSource('search-area', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
        
        // Search Area Fill (Faint)
        map.addLayer({
            'id': 'search-area-fill',
            'type': 'fill',
            'source': 'search-area',
            'layout': {},
            'paint': {
                'fill-color': '#4dabf7',
                'fill-opacity': 0.15
            }
        });
        
        // Search Area Outline (Dashed)
        map.addLayer({
            'id': 'search-area-outline',
            'type': 'line',
            'source': 'search-area',
            'layout': {},
            'paint': {
                'line-color': '#339af0',
                'line-dasharray': [4, 4],
                'line-width': 2
            }
        });

        // Add source for NOTAMs
        map.addSource('notams', {
            type: 'geojson',
            data: {
                type: 'FeatureCollection',
                features: []
            }
        });

        // Add Polygon Layer (for areas with radius)
        map.addLayer({
            'id': 'notam-areas',
            'type': 'fill',
            'source': 'notams',
            'filter': ['==', '$type', 'Polygon'],
            'paint': {
                'fill-color': [
                    'match',
                    ['get', 'category'],
                    'Runway', '#FA5252',
                    'Taxiway', '#FD7E14',
                    'Obstruction', '#FCC419',
                    'Aerodrome', '#82C91E',
                    'Airspace', '#228BE6',
                    '#868E96' // Default
                ],
                'fill-opacity': 0.3,
                'fill-outline-color': '#fff'
            }
        });

        // Add Point Layer (Center points)
        map.addLayer({
            'id': 'notam-points',
            'type': 'circle',
            'source': 'notams',
            'paint': {
                'circle-radius': 6,
                'circle-color': [
                    'match',
                    ['get', 'category'],
                    'Runway', '#FA5252',
                    'Taxiway', '#FD7E14',
                    'Obstruction', '#FCC419',
                    'Aerodrome', '#82C91E',
                    'Airspace', '#228BE6',
                    '#868E96' // Default
                ],
                'circle-stroke-width': 2,
                'circle-stroke-color': '#fff'
            }
        });

        // Interactions (Popup)
        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
            className: 'notam-mapbox-popup'
        });

        const showPopup = (e) => {
            map.getCanvas().style.cursor = 'pointer';

            const coordinates = e.features[0].geometry.type === 'Point' 
                ? e.features[0].geometry.coordinates.slice()
                : e.lngLat; // Use click location for polygons to ensure popup is visible
                
            const props = e.features[0].properties;
            
            const description = `
                <div class="notam-popup">
                    <h3>${props.number} <span class="tag" style="background:${getColor(props.category)}33; color:${getColor(props.category)}">${props.category}</span></h3>
                    <p><strong>Code:</strong> ${props.q_code || 'N/A'}</p>
                    <p><strong>Validity:</strong><br>
                    Start: ${formatDate(props.start_time)}<br>
                    End: ${formatDate(props.end_time)}</p>
                    <hr style="border:0; border-top:1px solid #444; margin:8px 0;">
                    <p style="font-family:monospace; font-size:0.85rem; white-space:pre-wrap;">${props.text}</p>
                </div>
            `;

            popup.setLngLat(coordinates).setHTML(description).addTo(map);
        };

        const hidePopup = () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
        };

        map.on('mouseenter', 'notam-points', showPopup);
        map.on('mouseleave', 'notam-points', hidePopup);
        map.on('mouseenter', 'notam-polygons', showPopup);
        map.on('mouseleave', 'notam-polygons', hidePopup);

        // Add click handlers for popups (Logic omitted for brevity, existing handlers remain)
        map.on('click', 'notam-polygons', (e) => showPopup(e));
        map.on('click', 'notam-points', (e) => showPopup(e));
        
        // Mouse cursor
        map.on('mouseenter', 'notam-polygons', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'notam-polygons', () => map.getCanvas().style.cursor = '');
        map.on('mouseenter', 'notam-points', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'notam-points', () => map.getCanvas().style.cursor = '');

    }

    // Click to search
    map.on('click', (e) => {
        document.getElementById('latInput').value = e.lngLat.lat.toFixed(4);
        document.getElementById('lonInput').value = e.lngLat.lng.toFixed(4);
        
        // Update marker
        if (currentMarker) currentMarker.remove();
        currentMarker = new mapboxgl.Marker({ color: "#FF0000" })
            .setLngLat(e.lngLat)
            .addTo(map);
            
        searchNotams();
    });

    async function searchNotams() {
        const lat = parseFloat(document.getElementById('latInput').value);
        const lon = parseFloat(document.getElementById('lonInput').value);
        const radius = parseFloat(document.getElementById('radiusInput').value); // Nautical Miles
        
        // Visualize Search Area using Turf.js
        // Convert NM to Kilometers (1 NM = 1.852 km)
        const radiusKm = radius * 1.852;
        const center = [lon, lat];
        const options = {steps: 64, units: 'kilometers'};
        const circle = turf.circle(center, radiusKm, options);
        
        if (map.getSource('search-area')) {
            map.getSource('search-area').setData(circle);
        }

        try {
            // Updated to Absolute URL for decoupled testing (Serving HTML separately from API)
            const response = await fetch(`http://localhost:8000/api/geojson?lat=${lat}&lon=${lon}&radius=${radius}`);
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`API Error: ${response.status} ${text}`);
            }

            const data = await response.json();
            
            // DEBUG: Print GeoJSON to Console
            console.log("NOTAM GeoJSON Results:", data);

            // Update Map Source
            if (map.getSource('notams')) {
                map.getSource('notams').setData(data);
            }
            
            // Render Side Panel
            renderNotamList(data.features);
            
            // Zoom to search area roughly
            map.easeTo({
                center: [lon, lat],
                zoom: Math.max(8, 11 - (radius / 20)) // Rough zoom approximation
            });
            
            // Auto open panel on search
            const panel = document.getElementById('sidePanel');
            if (!panel.classList.contains('open') && data.features.length > 0) {
                panel.classList.add('open');
            }
            
        } catch (err) {
            console.error("Error fetching NOTAMs:", err);
            alert(`Error fetching data: ${err.message}`);
        }
    }
    
    function toggleSidePanel() {
        document.getElementById('sidePanel').classList.toggle('open');
    }
    
    function renderNotamList(features) {
        const container = document.getElementById('notamListContainer');
        document.getElementById('notamCount').textContent = `(${features.length})`;
        container.innerHTML = '';
        
        if (features.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No NOTAMs found in this area.</div>';
            return;
        }
        
        features.forEach(f => {
            const p = f.properties;
            const color = getColor(p.category);
            
            const div = document.createElement('div');
            div.className = 'notam-list-item';
            div.style.borderLeftColor = color;
            
            div.innerHTML = `
                <div class="notam-header">
                    <span class="notam-id">${p.number} <span style="font-weight:normal; font-size:0.8em; color:${color}; opacity:0.8;">${p.category}</span></span>
                    <span class="notam-date">${formatDate(p.start_time).split(',')[0]}</span>
                </div>
                <div style="font-size:0.8rem; color:#ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    ${p.condition || 'Unknown Condition'}
                </div>
                
                <div class="notam-details">
                    <div class="detail-row"><span class="detail-label">Q-Code:</span> ${p.q_code || 'N/A'}</div>
                    <div class="detail-row"><span class="detail-label">Start:</span> ${formatDate(p.start_time)}</div>
                    <div class="detail-row"><span class="detail-label">End:</span> ${formatDate(p.end_time)}</div>
                    <div class="detail-row"><span class="detail-label">Min Alt:</span> ${p.lower_fl || '000'} FL</div>
                    <div class="detail-row"><span class="detail-label">Max Alt:</span> ${p.upper_fl || '999'} FL</div>
                    <div class="detail-row"><span class="detail-label">Radius:</span> ${p.radius_nm} NM</div>
                    
                    <div class="raw-text">${p.text}</div>
                    
                    <button style="margin-top:10px; font-size:0.8rem; padding:5px;" onclick="zoomToNotam([${f.geometry.coordinates[0][0]}, ${f.geometry.coordinates[0][1]}])">Map View</button>
                </div>
            `;
            
            // Toggle Expand
            div.addEventListener('click', (e) => {
                // Don't trigger if button clicked
                if (e.target.tagName === 'BUTTON') return;
                div.classList.toggle('expanded');
            });
            
            container.appendChild(div);
        });
    }
    
    function zoomToNotam(center) {
        // Handle Point vs Polygon center
        // Simplified: assuming Polygon's first point for now or center if passed
        // The geojson converter outputs Polygons or Points. 
        // We'll pass simpler logic later if needed, but for now specific coords passed in render
         map.flyTo({
            center: center,
            zoom: 12,
            speed: 1.5
        });
    }
    
    function getColor(category) {
        switch(category) {
            case 'Runway': return '#FA5252';
            case 'Taxiway': return '#FD7E14';
            case 'Obstruction': return '#FCC419';
            case 'Aerodrome': return '#82C91E';
            case 'Airspace': return '#228BE6';
            default: return '#868E96';
        }
    }
    
    function formatDate(str) {
        if (!str) return 'Perm';
        return new Date(str).toLocaleString();
    }
</script>

</body>
</html>
